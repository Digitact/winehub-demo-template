{{ 'customer.css' | asset_url | stylesheet_tag }}

<div class="customer account">
  <div>
    <h1>{{ 'customer.account.title' | t }}</h1>
    <a href="/account">Order History</a> | 
    <a href="/pages/subscriptions">Subscriptions</a> | 
    <a href="/pages/upcoming-shipments">Upcoming Shipments</a> | 
    <a href="/pages/payment-methods">Payment Methods</a> | 
    <a href="/pages/membershiptiers">Membership Tiers</a> |
    <a href="/pages/allocations">Allocations</a> | 
    <a href="/account/addresses">Addresses</a> | 
    <a href="{{ routes.account_logout_url }}">{{ 'customer.log_out' | t }}</a>
  </div>

  <div>
    <div>

      <h2>Exclusive Allocations</h2>

      <h4>Currently available</h4>
      <table id='available-allocations'>
        <thead>
          <tr>
            <th>
              
            </th>
            <th>
              Image
            </th>
            <th>
              Product
            </th>
            <th>
              Expires
            </th>
            <th>
              Claimable Allocations
            </th>
          </tr>
        </thead>
        <tbody id='available-allocations-area'>
        
        </tbody>
      </table>

      <h4>Expired</h4>
      <table id='expired-allocations'>
        <thead>
          <tr>
            <th>
              
            </th>
            <th>
              Image
            </th>
            <th>
              Product
            </th>
            <th>
              Expires
            </th>
            <th>
              Claimable Allocations
            </th>
          </tr>
        </thead>
        <tbody id='expired-allocations-area'>
        
        </tbody>
      </table>
    </div>
  </div>
</div>


<style>

</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>

  {% if shop.permanent_domain == 'winehub-demo.myshopify.com' %}
    var app_domain = 'https://wineclub-demo.digitact.co.uk';
  {% else %}
    var app_domain = 'https://howards-folly-wine.digitact.co.uk';
  {% endif %}
  
    $(function () {
      //alert("Loading content");  
      getAllocations();        
    }); 
  
  function getAllocations() {
      $.ajax({
        url: app_domain+'/app/api/product_allocations/{{customer.id}}',
        type: "GET",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (response) {
          data = response.customer_allocations;
          console.log(data);
          console.log(data.length);
          if (data.length) {
            $(data).each(function (index, item) {

              let id = item['id'];
              let featureImage = item['featureImage'];
              let createdAt = item['createdAt'];
              let createdDate = Date.parse(createdAt["date"])
              let publishedAt = item['publishedAt'];
              let publishedDate = Date.parse(publishedAt["date"])
              let expiresAt = item['expiresAt'];
              let expiresDate = Date.parse(expiresAt["date"])
              let published = item['published'];
              let individualAllocations = item['individualAllocations'];
              
              let row = '<tr id="allocation-item">'
              row += '<td id="allocation-id" style="display:none">' + id + '</td>'
              row += '<td id="allocation-image"><img src="' + featureImage + '" style="max-height: 150px"></td>'
              row += '<td id="allocation-creation">' + publishedDate + '</td>'
              row += '<td id="allocation-creation">' + expiresDate + '</td>'
              row += '<td id="allocation-creation">' + individualAllocations + '</td>'
              row += '</tr>'

              if(expiresAt > Date()) {
                $('#available-allocations-area').append(row);
              }
              else {
                $('#expired-allocations-area').append(row);
              }
            }
          }
        },
        error: function (data) { alert(data.responseText); }
      }); 
  }
  
</script>

