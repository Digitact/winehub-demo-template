{{ 'customer.css' | asset_url | stylesheet_tag }}

<div class="customer account">
  <div>
    <h1>{{ 'customer.account.title' | t }}</h1>
    <a href="/account">Order History</a> | 
    <a href="/pages/subscriptions">Subscriptions</a> | 
    <a href="/pages/upcoming-shipments">Upcoming Shipments</a> | 
    <a href="/pages/payment-methods">Payment Methods</a> | 
    <a href="/account/addresses">Addresses</a> | 
    <a href="{{ routes.account_logout_url }}">{{ 'customer.log_out' | t }}</a>
  </div>

  <div>
    <div>

      <h2>Subscriptions</h2>

      <table role="table" class="order-history">
        <caption class="visually-hidden">Wine Club Subscriptions</caption>
        <thead role="rowgroup">
          <tr role="row">
            <th id="ColumnOrder" scope="col" role="columnheader">Image</th>
            <th id="ColumnOrder" scope="col" role="columnheader">Subscription</th>
            <th id="ColumnDate" scope="col" role="columnheader">Started</th>
            <th id="ColumnPayment" scope="col" role="columnheader">Next Shipment</th>
            <th id="ColumnFulfillment" scope="col" role="columnheader">Status</th>
            
            <th id="ColumnAction" scope="col" role="columnheader"></th>
          </tr>
        </thead>
        <tbody id="subscription_tbody" role="rowgroup">
          <tr role="row">
            <td colspan="10" style="text-align: left;">Loading...</td>
          </tr>
        </tbody>
      </table>   

    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- jQuery Modal -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />

<script>
  //<th id="ColumnTotal" scope="col" role="columnheader">Total</th>

  {% if shop.permanent_domain == 'winehub-demo.myshopify.com' %}
    var app_domain = 'https://wineclub-demo.digitact.co.uk';
  {% else %}
    var app_domain = 'https://howards-folly-wine.digitact.co.uk';
  {% endif %}  
  
    $(function () {
      //alert("Loading content");  
      updateList();        
    }); 
  
  function updateList() {
    
      $.ajax({
        //url: app_domain+'/api/subscription_contracts?page=1&customer.shopifyId={{customer.id}}',
        url: app_domain+'/app/api/subscription_contracts/{{customer.id}}',
        type: "GET",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data) {
          $('#subscription_tbody').html("");
          console.log(data);
          console.log(data.length);
          if (data.length) {
            $(data).each(function (index, item) {
              //console.log(data[index].shopifyId);
/*
              currencyCode = data[index].deliveryPriceCurrencyCode;
        	  if (currencyCode===undefined) currencyCode = 'EUR';

              var formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currencyCode,
                // These options are needed to round to whole numbers if that's what you want.
                //minimumFractionDigits: 0, // (this suffices for whole numbers, but will print 2500.10 as $2,500.1)
                //maximumFractionDigits: 0, // (causes 2500.99 to be printed as $2,501)
              });         
*/
              var row = '';
              row += '<tr role="row">';
              row += '<td headers="RowOrder ColumnImage" role="cell">';
              row += '<img src="'+data[index].image+'" style="max-width:140px; max-height:140px;" />';
              row += '</td>';    
              row += '<td';
              row += '    id="RowOrder"';
              row += '    role="cell"';
              row += '    headers="ColumnOrder"';
              row += '    data-label=""';
              row += '    >';
              //row += '  <a href="#" class="open-modal" data-open="modal1">';
              row += data[index].product_name;
              row += '  <br />';
              //row += data[index].sellingPlanGroupName;
              //row += '  <br />';
              row += data[index].selling_plan_name;
              //row += '  <br />';
              //row += '  </a>';
              row += '</td>';
              row += '<td headers="RowOrder ColumnDate" role="cell">';
              row += new Date(data[index].signed_up).toDateString();
              row += '</td>';              
              row += '<td headers="RowOrder ColumnPayment" role="cell">';
              if (data[index].status.toUpperCase()=='PAUSED') {
                row += '-';  
              } else {
                row += new Date(data[index].signed_up).toDateString();
              }
              row += '</td>';
              row += '<td headers="RowOrder ColumnFulfillment" role="cell">';
              row += data[index].status.toUpperCase();
              row += '</td>';
              //row += '<td headers="RowOrder ColumnTotal" role="cell">';
              //row += formatter.format(data[index].deliveryPriceAmount);
              //row += '</td>';
    		  row += '<td headers="RowOrder ColumnAction" role="cell" style="padding:1.2rem;">';
    		  //row += '<button class="button button--primary" style="margin:0 0 3px 3px; width: 220px;" onClick="editSubscription(\''+data[index].contract_shopify_id+'\');">Edit Subscription</button><br />';
              if (data[index].status.toUpperCase()=='ACTIVE') {
                row += '<button class="button button--primary" style="margin:0 0 3px 3px; width: 220px;" onClick="pauseSubscription(\''+data[index].contract_shopify_id+'\');">Pause Subscription</button><br />';  
              } else if (data[index].status.toUpperCase()=='PAUSED') {
                row += '<button class="button button--primary" style="margin:0 0 3px 3px; width: 220px;" onClick="unpauseSubscription(\''+data[index].contract_shopify_id+'\');">Unpause Subscription</button><br />';  
              }      
              if (data[index].status.toUpperCase()!='CANCELLED') {
                row += '<button class="button button--primary" style="margin:0 0 3px 3px; width: 220px;" onClick="cancelSubscription(\''+data[index].contract_shopify_id+'\');">Cancel Subscription</button><br />';
              }
              row += '</td>';
              row += '</tr>';
              $('#subscription_tbody').append(row);     
            });           

          } else {
              var row = '';
              row += '<tr role="row">';
              row += '<td colspan="10" style="text-align: left;">No subscription records found</td>';
              row += '</tr>';
              $('#subscription_tbody').append(row);               
          }         
        },
        error: function (data) { alert(data.responseText); }
      });
    
    
  }

  function editSubscription(id) {
    if (confirm("Are you sure you wish to edit this contract?") == true) {
    }   
  }

  function pauseSubscription(id) {
    if (confirm("Are you sure you wish to pause this contract?") == true) {

      var row = '';
      row += '<tr role="row">';
      row += '<td colspan="10" style="text-align: left;">Updating...</td>';
      row += '</tr>';
      $('#subscription_tbody').html(row);
      
	  $.ajax({
        url: app_domain+'/pausesubscription/'+id,
        type: "GET",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data) {
          $('#subscription_tbody').html("");
		  updateList();            
        },
        error: function (data) { alert(data.responseText); }
      });   
      
    }   
  }  

  function unpauseSubscription(id) {
    if (confirm("Are you sure you wish to pause this contract?") == true) {

      var row = '';
      row += '<tr role="row">';
      row += '<td colspan="10" style="text-align: left;">Updating...</td>';
      row += '</tr>';
      $('#subscription_tbody').html(row);
      
	  $.ajax({
        url: app_domain+'/unpausesubscription/'+id,
        type: "GET",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data) {
          $('#subscription_tbody').html("");
		  updateList();            
        },
        error: function (data) { alert(data.responseText); }
      });   
      
    }   
  }    
  
  function cancelSubscription(id) {
    if (confirm("Are you sure you wish to cancel this contract?") == true) {

      var row = '';
      row += '<tr role="row">';
      row += '<td colspan="10" style="text-align: left;">Updating...</td>';
      row += '</tr>';
      $('#subscription_tbody').html(row);
      
	  $.ajax({
        url: app_domain+'/cancelsubscription/'+id,
        type: "GET",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data) {
          $('#subscription_tbody').html("");
		  updateList();            
        },
        error: function (data) { alert(data.responseText); }
      });      
      
    }   
  }
  
</script>

